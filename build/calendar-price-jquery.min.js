/* calendar-pirce-jquery | version: 1.0.0 | author: Capricorncd | 2017-06-18 */
!function(a){function b(c){c.el||(console.error("显示日历的容器el未配置!"),c.error&&c.error({code:1,msg:"请配置日历显示的容器!"})),this.opts=a.extend({},b.DEFAULTS,c),this.month=this._formatThisMonth(this.opts.month),this.startDate=this._getStartDate(),this.endDate=this._getEndDate(),this.data=this._getOptionsData(),this.Initialization(),this.setupDayDetailWindow()}function c(a,b){/(y+)/i.test(b)&&(b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));var c={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds()};for(var e in c)if(new RegExp("("+e+")").test(b)){var f=c[e]+"";b=b.replace(RegExp.$1,1===RegExp.$1.length?f:d(f))}return b}function d(a){return a=a.toString(),a[1]?a:"0"+a}function e(a){return a=parseInt(a),isNaN(a)?0:a}var f=new Date,g=c(f,"yyyy-MM-dd"),h=c(new Date(f.getTime()+864e5),"yyyy-MM-dd"),i=864e5,j=b.prototype;b.DEFAULTS={data:[],month:c(f,"yyyy/MM"),startDate:c(f,"yyyy/MM/dd"),endDate:null,cancel:null,callback:null,error:null,style:{bgColor:"#fff"}},j._formatThisMonth=function(a){return/^(\d{4})[\.-\/](\d{1,2})/.test(a)?this.dateToObject(RegExp.$1+"/"+RegExp.$2):this.dateToObject(c(f,"yyyy/MM"))},j.Initialization=function(){this.createCalendar();var b=this;a(this.opts.el).on("click",".prev-month",function(){b._prevMonth()}),a(this.opts.el).on("click",".next-month",function(){b._nextMonth()}),this.setupPriceAndStock(),a(this.opts.el).on("click",".btn-reset",function(){b.data=b._getOptionsData(),console.log("reset completed!")}),a(this.opts.el).on("click",".btn-submit",function(){b.opts.callback&&b.opts.callback(b.data)}),a(this.opts.el).on("click",".btn-cancel",function(){b.opts.cancel&&b.opts.cancel()})},j._prevMonth=function(){var a=e(c(this.month,"yyyy")),b=e(c(this.month,"MM"));this.month=1===b?this.dateToObject(a-1+"/12"):this.dateToObject(a+"/"+(b-1)),this.createCalendar()},j._nextMonth=function(){var a=e(c(this.month,"yyyy")),b=e(c(this.month,"MM"));this.month=12===b?this.dateToObject(a+1+"/01"):this.dateToObject(a+"/"+(b+1)),this.createCalendar()},j._getStartDate=function(){var a=this.opts.startDate;return this.dateToObject(a)?this.dateToObject(a):f},j._getEndDate=function(){var a=this.opts.endDate;if(this.dateToObject(a))return this.dateToObject(a);var b=e(c(f,"yyyy")),d=c(f,"MM");return this.dateToObject(b+1+"/"+d)},j.dateToObject=function(a){var b="";return/(\d{4})[-\/\.](\d{1,2})[-\/\.]?/.test(a)&&(b+=RegExp.$1+"/"+RegExp.$2),/[-\/\.]\d{1,2}[-\/\.](\d{1,2})/.test(a)?b+="/"+RegExp.$1:b+="/01",/\d{4}\/\d{1,2}\/\d{1,2}/.test(b)?new Date(b):(this.opts.error&&this.opts.error({code:1,msg:a+": 日期格式不合法!"}),!1)},j.createCalendar=function(){var b=!0,d=!0,e=c(this.month,"yyyyMM");c(f,"yyyyMM")>=e&&(b=!1),c(this.endDate,"yyyyMM")<=e&&(d=!1);var g="";g+='<div class="capricorncd-calendar-container">',g+='\t<div class="calendar-head-wrapper">',b&&(g+='       <a class="prev-month" title="上一月"></a>'),g+='\t\t<div class="calendar-month-title">'+c(this.month,"yyyy年MM月")+"</div>",d&&(g+='       <a class="next-month" title="下一月"></a>'),g+="\t</div>",g+='\t<div class="calendar-table-wrapper">',g+='  \t    <table cellpadding="4" cellspacing="0">',g+='\t\t    <thead><tr class="week"><th class="weekend">日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th class="weekend">六</th></tr></thead>',g+="\t\t    <tbody>"+this._createTbody()+"</tbody>",g+="\t    </table>",g+="    </div>",g+='    <div class="calendar-foot-wrapper">',g+='        <button class="btn btn-reset">重置</button>',g+='        <button class="btn btn-submit">确定</button>',g+='        <button class="btn btn-cancel">取消</button>',g+="    </div>",g+="</div>",a(this.opts.el).html(g),this.renderDataToTalbe()},j._createTbody=function(){for(var a=this._getMonthDays(),b=this.month.getDay(),e=0,i=Math.ceil((a+b)/7),j="",k="",l=0;l<i;l++){k+="<tr>";for(var m=1;m<=7;m++)e=7*l+m-b,e>0&&e<=a?(j=c(this.month,"yyyy-MM-")+d(e),g==j&&(e="今天"),h==j&&(e="明天"),j>=c(f,"yyyy-MM-dd")?k+='<td class="valid-hook" data-week="'+(m-1)+'" data-id="'+j+'"><b>'+e+'</b><div class="data-hook"></div></td>':k+='<td class="disabled"><b>'+e+"</b></td>"):k+="<td>&nbsp;</td>";k+="</tr>"}return k},j.renderDataToTalbe=function(){var b=this,c=a(this.opts.el).find(".valid-hook"),d=null;c.each(function(){d=b._getDateData(a(this).data("id"));var c=b.dayComplate().toString();if(d){for(var e in d)c=c.replace("{"+e+"}",d[e]);a(this).data("data",JSON.stringify(d)).find(".data-hook").html(c)}else a(this).data("data","{}")})},j._getDateData=function(a){for(var b=this.data,c=0;c<b.length;c++)if(a==b[c].date)return b[c];return null},j._getMonthDays=function(){var a=this.month,b=c(a,"yyyy"),d=c(a,"MM");return 12==d?31:new Date(Date.parse(new Date(b,d,1))-864e5).getDate()},j.setupDayDetailWindow=function(){var b="";b+='<div class="cddsw-container">',b+='   <div class="cddsw-head-wrapper">',b+='       <div class="cddsw-title">0000-00-00</div>',b+='       <a class="cddsw-close"><i></i></a>',b+="   </div>",b+='   <ul class="cddsw-form-wrapper clearfix">',b+=this._createDaySetupInputGroup(),b+="   </ul>",b+='   <fieldset class="cddsw-batch-settings clearfix">',b+='       <legend class="bs-title"><b>批量设置</b></legend>',b+='       <div class="bs-content">',b+='           <lable class="bs-lable">日期范围</lable>',b+='           <div class="bs-options-wrapper">',b+='               <input class="itext" name="startDay" type="text">',b+='               <span class="white-space">-</span>',b+='               <input class="itext" name="endDay" type="text">',b+='               <label class="drw-enable"><input name="enableDateRange" type="checkbox"> 启用</label>',b+="           </div>",b+="       </div>",b+='       <div class="bs-content bs-week-chekbox">',b+='           <lable class="bs-lable">设置星期</lable>',b+='           <div class="bs-options-wrapper">',b+='               <label><input name="setWeek" type="checkbox" value="1"> 周一</label>',b+='               <label><input name="setWeek" type="checkbox" value="2"> 周二</label>',b+='               <label><input name="setWeek" type="checkbox" value="3"> 周三</label>',b+='               <label><input name="setWeek" type="checkbox" value="4"> 周四</label>',b+='               <label><input name="setWeek" type="checkbox" value="5"> 周五</label>',b+='               <label><input name="setWeek" type="checkbox" value="6"> 周六</label>',b+='               <label><input name="setWeek" type="checkbox" value="0"> 周日</label>',b+="           </div>",b+="       </div>",b+="   </fieldset>",b+='   <div class="cddsw-foot-wrapper">',b+='       <button class="btn-submit">启用本设置</button>',b+='       <button class="btn-cancel">取消</button>',b+="   </div>",b+="</div>",a("body").append('<div class="capricorncd-date-detailed-settings" style="display: none">'+b+"</div>")},j._createDaySetupInputGroup=function(){for(var a="",b=this.opts.config,c=0;c<b.length;c++){var d=b[c];a+="<li>",a+="   <label>"+d.name+"</label>",a+='   <input name="'+d.key+'" type="text">',a+="</li>"}return a},j.dayComplate=function(){var a=this.opts.show,b="";if(a&&a instanceof Array)for(var c=0;c<a.length;c++){var d=a[c];b+="<p>"+d.abbreviate+"{"+d.key+"}</p>"}return b},j.setupPriceAndStock=function(){var b=this;a(this.opts.el).on("click",".valid-hook",function(){var b=a(".capricorncd-date-detailed-settings");b.find('.cddsw-form-wrapper [type="text"]').val(""),b.find('[name="enableDateRange"]').prop("checked",!1),b.find('[name="setWeek"]').prop("checked",!1);var c=a(this).data("id"),d=a(this).data("data");try{d=JSON.parse(d)}catch(a){d={}}a.each(d,function(a,c){b.find('[name="'+a+'"]').val(c)}),b.find(".cddsw-title").html(c),b.find('[name="startDay"], [name="endDay"]').val(c),b.show()}),a("body").on("click",".capricorncd-date-detailed-settings .cddsw-close, .capricorncd-date-detailed-settings .btn-cancel",function(){a(this).closest(".capricorncd-date-detailed-settings").hide()}),a("body").on("click",".capricorncd-date-detailed-settings .btn-submit",function(){var c=a(this).closest(".cddsw-container"),d=c.find(".cddsw-title").text(),e={};c.find(".cddsw-form-wrapper [name]").each(function(){var b=a(this).attr("name"),c=a(this).val();e[b]=c}),e.date=d,console.log(e);var f=a(".cddsw-batch-settings"),g=f.find('[name="startDay"]').val(),h=f.find('[name="endDay"]').val(),i=f.find('[name="enableDateRange"]').prop("checked"),j=f.find('[name="setWeek"]:checked'),k=[];j.each(function(){k.push(a(this).val())}),console.log(k);var l=[];if(i){var m=b.handleSetDateRangeData(g,h);if(!m)return;l=m}else if(0===k.length)return void b.handleThisData(e);b.handleSetWeekData(k,l,function(a){b.handleThisData(e,a.data)})})},j.handleSetDateRangeData=function(a,b){function e(a){return!!/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})/.test(a)&&RegExp.$1+"/"+d(RegExp.$2)+"/"+d(RegExp.$3)}var f=this,h=[],j=e(a),k=e(b);return j?j<g?(this.opts.error&&this.opts.error({code:1,msg:"开始日期不能小于今天"}),!1):k?k<j?(this.opts.error&&this.opts.error({code:1,msg:"结束日期不能小于开始日期"}),!1):(j==k?h.push(c(j,"yyyy-MM-dd")):h=function(a,b){for(var d=[],e=Date.parse(f.dateToObject(a)),g=Date.parse(f.dateToObject(b)),h=Math.floor((g-e)/i)+1,j=0;j<h;j++){var k=new Date(e+i*j);d.push(c(k,"yyyy-MM-dd"))}return d}(j,k),h):(this.opts.error&&this.opts.error({code:1,msg:"结束日期格式错误"}),!1):(this.opts.error&&this.opts.error({code:1,msg:"开始日期格式错误"}),!1)},j.handleSetWeekData=function(a,b,c){var d=[];console.warn(b),c&&c({code:0,msg:"completed",data:d})},j.handleThisData=function(b,c){function d(b){var c=!1;console.warn(b),a.each(e.data,function(a,d){d.date===b.date&&(c=!0,e.data[a]=b)}),c||e.data.push(b)}var e=this,f=c||[],g=f.length;if(0===g)d(b);else for(var h=0;h<g;h++)b.date=f[h],d(b);this.renderDataToTalbe(),a(".capricorncd-date-detailed-settings").hide()},j._getOptionsData=function(){return this.opts.data instanceof Array?this.opts.data:[]},a.extend({CalendarPrice:function(a){new b(a)}})}(jQuery);