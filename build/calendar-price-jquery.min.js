/* calendar-pirce-jquery | version: 1.0.0 | author: Capricorncd | 2017-06-20 */
"use strict";!function(a){function b(c){c.el||c.error&&c.error({code:1,msg:"请配置日历显示的容器!"}),this.opts=a.extend({},b.DEFAULTS,c),this.startDate=this._getStartDate(),this.endDate=this._getEndDate(),this.data=this._getOptionsData(),this.month=this._formatThisMonth(this.opts.month),this.Initialization(),this.setupDayDetailWindow()}function c(a,b){/(y+)/i.test(b)&&(b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));var c={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds()};for(var e in c)if(new RegExp("("+e+")").test(b)){var f=c[e]+"";b=b.replace(RegExp.$1,1===RegExp.$1.length?f:d(f))}return b}function d(a){return a=a.toString(),a[1]?a:"0"+a}function e(a){return a=parseInt(a),isNaN(a)?0:a}var f=new Date,g=c(f,"yyyy-MM-dd"),h=864e5,i=c(new Date(Date.parse(f)+h),"yyyy-MM-dd"),j=b.prototype;b.DEFAULTS={data:[],month:c(f,"yyyy/MM"),startDate:c(f,"yyyy/MM/dd"),endDate:null,cancel:null,callback:null,error:null,style:{bgColor:"#fff"}},j._formatThisMonth=function(a){var b=null;return b=/^(\d{4})[-\.\/](\d{1,2})/.test(a)?this.dateToObject(RegExp.$1+"/"+RegExp.$2):this.dateToObject(c(f,"yyyy/MM")),b<=this.endDate&&b>=this.startDate?b:this.dateToObject(c(this.startDate,"yyyy/MM"))},j.Initialization=function(){this.createCalendar();var b=this;a(this.opts.el).on("click",".prev-month",function(){b._prevMonth()}),a(this.opts.el).on("click",".next-month",function(){b._nextMonth()}),this.setupPriceAndStock(),a(this.opts.el).on("click",".btn-reset",function(){b.data=b._getOptionsData(),console.log("reset completed!")}),a(this.opts.el).on("click",".btn-submit",function(){b.opts.callback&&b.opts.callback(b.data)}),a(this.opts.el).on("click",".btn-cancel",function(){b.opts.cancel&&b.opts.cancel()})},j._prevMonth=function(){var a=e(c(this.month,"yyyy")),b=e(c(this.month,"MM"));this.month=1===b?this.dateToObject(a-1+"/12"):this.dateToObject(a+"/"+(b-1)),this.createCalendar()},j._nextMonth=function(){var a=e(c(this.month,"yyyy")),b=e(c(this.month,"MM"));this.month=12===b?this.dateToObject(a+1+"/01"):this.dateToObject(a+"/"+(b+1)),this.createCalendar()},j._getStartDate=function(){var a=this.dateToObject(this.opts.startDate);return a&&a>=f?a:f},j._getEndDate=function(){var a=this.opts.endDate,b=null,d=null,g=null;return/^(\d{4})[-\.\/](\d{1,2})/.test(a)&&(b=RegExp.$1,d=e(RegExp.$2)),b&&d||(b=e(c(f,"yyyy"))+1,d=e(c(f,"MM"))),g=/^\d{4}[-\.\/]\d{1,2}[-\.\/](\d{1,2})/.test(a)?RegExp.$1:new Date(Date.parse(new Date(b,d))-h).getDate(),this.dateToObject(b+"/"+d+"/"+g)},j.dateToObject=function(a){var b="";return/(\d{4})[-\/\.](\d{1,2})[-\/\.]?/.test(a)&&(b+=RegExp.$1+"/"+RegExp.$2),/[-\/\.]\d{1,2}[-\/\.](\d{1,2})/.test(a)?b+="/"+RegExp.$1:b+="/01",/\d{4}\/\d{1,2}\/\d{1,2}/.test(b)?new Date(b):(this.opts.error&&this.opts.error({code:1,msg:a+": 日期格式不合法!"}),!1)},j.createCalendar=function(){var b=!0,d=!0,e=c(this.month,"yyyyMM");c(this.startDate,"yyyyMM")>=e&&(b=!1),c(this.endDate,"yyyyMM")<=e&&(d=!1);var f="";f+='<div class="capricorncd-calendar-container">',f+='\t<div class="calendar-head-wrapper">',b&&(f+='       <a class="prev-month" title="上一月"></a>'),f+='\t\t<div class="calendar-month-title">'+c(this.month,"yyyy年MM月")+"</div>",d&&(f+='       <a class="next-month" title="下一月"></a>'),f+="\t</div>",f+='\t<div class="calendar-table-wrapper">',f+='  \t    <table cellpadding="4" cellspacing="0">',f+='\t\t    <thead><tr class="week"><th class="weekend">日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th class="weekend">六</th></tr></thead>',f+="\t\t    <tbody>"+this._createTbody()+"</tbody>",f+="\t    </table>",f+="    </div>",f+='    <div class="calendar-foot-wrapper">',f+='        <button class="btn btn-reset">重置</button>',f+='        <button class="btn btn-submit">确定</button>',f+='        <button class="btn btn-cancel">取消</button>',f+="    </div>",f+="</div>",a(this.opts.el).html(f),this.renderDataToTalbe()},j._createTbody=function(){for(var a=this._getMonthDays(),b=this.month.getDay(),e=0,f=Math.ceil((a+b)/7),h="",j="",k=0;k<f;k++){j+="<tr>";for(var l=1;l<=7;l++)e=7*k+l-b,e>0&&e<=a?(h=c(this.month,"yyyy-MM-")+d(e),g==h&&(e="今天"),i==h&&(e="明天"),h>=c(this.startDate,"yyyy-MM-dd")?j+='<td class="valid-hook" data-week="'+(l-1)+'" data-id="'+h+'"><b>'+e+'</b><div class="data-hook"></div></td>':j+='<td class="disabled"><b>'+e+"</b></td>"):j+="<td>&nbsp;</td>";j+="</tr>"}return j},j.renderDataToTalbe=function(){var b=this,c=a(this.opts.el).find(".valid-hook"),d=null;c.each(function(){d=b._getDateData(a(this).data("id"));var c=b.dayComplate().toString();if(d){for(var e in d)c=c.replace("{"+e+"}",d[e]);a(this).data("data",JSON.stringify(d)).find(".data-hook").html(c)}else a(this).data("data","{}")})},j._getDateData=function(a){for(var b=this.data,c=0;c<b.length;c++)if(a==b[c].date)return b[c];return null},j._getMonthDays=function(){var a=this.month,b=c(a,"yyyy"),d=c(a,"MM");return 12==d?31:new Date(Date.parse(new Date(b,d,1))-h).getDate()},j.setupDayDetailWindow=function(){var b="";b+='<div class="cddsw-container">',b+='   <div class="cddsw-head-wrapper">',b+='       <div class="cddsw-title">0000-00-00</div>',b+='       <a class="cddsw-close"><i></i></a>',b+="   </div>",b+='   <ul class="cddsw-form-wrapper clearfix">',b+=this._createDaySetupInputGroup(),b+="   </ul>",b+='   <fieldset class="cddsw-batch-settings clearfix">',b+='       <legend class="bs-title"><b>批量设置</b></legend>',b+='       <div class="bs-content">',b+='           <lable class="bs-lable">日期范围</lable>',b+='           <div class="bs-options-wrapper">',b+='               <input class="itext" name="startDay" type="text">',b+='               <span class="white-space">-</span>',b+='               <input class="itext" name="endDay" type="text">',b+='               <label class="drw-enable"><input name="enableDateRange" type="checkbox"> 启用</label>',b+="           </div>",b+="       </div>",b+='       <div class="bs-content bs-week-chekbox">',b+='           <lable class="bs-lable">设置星期</lable>',b+='           <div class="bs-options-wrapper">',b+='               <label><input name="setWeek" type="checkbox" value="1"> 周一</label>',b+='               <label><input name="setWeek" type="checkbox" value="2"> 周二</label>',b+='               <label><input name="setWeek" type="checkbox" value="3"> 周三</label>',b+='               <label><input name="setWeek" type="checkbox" value="4"> 周四</label>',b+='               <label><input name="setWeek" type="checkbox" value="5"> 周五</label>',b+='               <label><input name="setWeek" type="checkbox" value="6"> 周六</label>',b+='               <label><input name="setWeek" type="checkbox" value="0"> 周日</label>',b+="           </div>",b+="       </div>",b+="   </fieldset>",b+='   <div class="cddsw-foot-wrapper">',b+='       <button class="btn-submit">启用本设置</button>',b+='       <button class="btn-cancel">取消</button>',b+="   </div>",b+="</div>",a("body").append('<div class="capricorncd-date-detailed-settings" style="display: none">'+b+"</div>")},j._createDaySetupInputGroup=function(){for(var a="",b=this.opts.config,c=0;c<b.length;c++){var d=b[c];a+="<li>",a+="   <label>"+d.name+"</label>",a+='   <input name="'+d.key+'" type="text">',a+="</li>"}return a},j.dayComplate=function(){var a=this.opts.show,b="";if(a&&a instanceof Array)for(var c=0;c<a.length;c++){var d=a[c];b+="<p>"+d.abbreviate+"{"+d.key+"}</p>"}return b},j.setupPriceAndStock=function(){var b=this;a(this.opts.el).on("click",".valid-hook",function(){var b=a(".capricorncd-date-detailed-settings");b.find('.cddsw-form-wrapper [type="text"]').val(""),b.find('[name="enableDateRange"]').prop("checked",!1),b.find('[name="setWeek"]').prop("checked",!1);var c=a(this).data("id"),d=a(this).data("data");try{d=JSON.parse(d)}catch(a){d={}}a.each(d,function(a,c){b.find('[name="'+a+'"]').val(c)}),b.find(".cddsw-title").html(c),b.find('[name="startDay"], [name="endDay"]').val(c),b.show()}),a("body").on("click",".capricorncd-date-detailed-settings .cddsw-close, .capricorncd-date-detailed-settings .btn-cancel",function(){a(this).closest(".capricorncd-date-detailed-settings").hide()}),a("body").on("click",".capricorncd-date-detailed-settings .btn-submit",function(){var d=a(this).closest(".cddsw-container"),e=d.find(".cddsw-title").text(),f={};d.find(".cddsw-form-wrapper [name]").each(function(){var b=a(this).attr("name"),c=a(this).val();f[b]=c}),f.date=e,console.log(f);var g=a(".cddsw-batch-settings"),h=g.find('[name="startDay"]').val(),i=g.find('[name="endDay"]').val(),j=g.find('[name="enableDateRange"]').prop("checked"),k=g.find('[name="setWeek"]:checked'),l=[];k.each(function(){l.push(a(this).val())});var m=[];if(j){var n=b.handleSetDateRangeData(h,i);if(!n)return;if(m=n,0===l.length)return void b.handleThisData(f,m)}else{if(0===l.length)return void b.handleThisData(f);m=b.handleSetDateRangeData(c(b.startDate,"yyyy-MM-dd"),c(b.endDate,"yyyy-MM-dd"))}b.handleSetWeekData(l,m,function(a){a.data.length>0?b.handleThisData(f,a.data):b.opts.error&&b.opts.error({code:1,msg:"设置的日期范围或初始化的日期范围，与设置的周"+l.join(",")+"没有交集"})})})},j.handleSetDateRangeData=function(a,b){function e(a){return!!/^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})/.test(a)&&RegExp.$1+"/"+d(RegExp.$2)+"/"+d(RegExp.$3)}var f=this,i=[],j=e(a),k=e(b);return j?j<g?(this.opts.error&&this.opts.error({code:1,msg:"开始日期不能小于今天"}),!1):k?k<j?(this.opts.error&&this.opts.error({code:1,msg:"结束日期不能小于开始日期"}),!1):(j==k?i.push(c(this.dateToObject(j),"yyyy-MM-dd")):i=function(a,b){for(var d=[],e=Date.parse(f.dateToObject(a)),g=Date.parse(f.dateToObject(b)),i=Math.floor((g-e)/h)+1,j=0;j<i;j++){var k=new Date(e+h*j);d.push(c(k,"yyyy-MM-dd"))}return d}(j,k),i):(this.opts.error&&this.opts.error({code:1,msg:"结束日期格式错误"}),!1):(this.opts.error&&this.opts.error({code:1,msg:"开始日期格式错误"}),!1)},j.handleSetWeekData=function(b,c,d){var e=this,f=b.join(","),g=[];a.each(c,function(a,b){var c=e.dateToObject(b).getDay();f.indexOf(c)>-1&&g.push(b)}),d&&d({code:0,msg:"completed",data:g})},j.handleThisData=function(b,c){var d=c||[],e=d.length;if(console.log(d),0===e)this._updateThisData(b);else for(var f=0;f<e;f++)this._updateThisData(b,d[f]);this.data=this.sort(this.rmRepeat(this.data,"date")),this.renderDataToTalbe(),a(".capricorncd-date-detailed-settings").hide()},j._updateThisData=function(b,c){var d=this,e=!1,f={};f.date=c||b.date,a.each(b,function(a,b){"date"!=a&&(f[a]=b)}),a.each(this.data,function(a,b){if(f.date===b.date)return e=!0,d.data[a]=f,!1}),e||this.data.push(f)},j._getOptionsData=function(){var a=c(this.startDate,"yyyy-MM-dd"),b=[],d=this.opts.data;if(d&&d instanceof Array)for(var e=0;e<d.length;e++)d[e].date>=a&&b.push(d[e]);return this.sort(this.rmRepeat(b,"date"))},j.sort=function(a){if(!(a instanceof Array))return this.opts.error&&this.opts.error({code:1,msg:"this.sort 传入的arr为非数组"}),a;if(a.length<1)return a;for(var b=0,c=null,d=0;d<a.length;d++){b=d;for(var e=d+1;e<a.length;e++)a[e].date<a[b].date&&(b=e,c=a[d],a.splice(d,1,a[e]),a.splice(e,1,c))}return a},j.rmRepeat=function(a,b){for(var c={},d=[],e=0;e<a.length;e++){var f=a[e];if(b)try{f=a[e][b]}catch(a){}c[f]||(d.push(a[e]),c[f]=!0)}return d},a.extend({CalendarPrice:function(a){new b(a)}})}(jQuery);